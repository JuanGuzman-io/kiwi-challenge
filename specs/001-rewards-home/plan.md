# Implementation Plan: Rewards Overview (Rewards Home)

**Branch**: `001-rewards-home` | **Date**: 2026-01-11 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-rewards-home/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command based on the feature specification and clarifications.

## Summary

This feature implements a React-based frontend rewards overview screen that displays a user's accumulated rewards balance and transaction history with pagination support. Users can view their balance, browse transactions grouped by month, load more transactions, and initiate withdrawals. The implementation follows a mobile-first responsive design (375px base width) with full keyboard accessibility (WCAG 2.1 AA compliance). The frontend integrates with existing backend API endpoints (GET /rewards/summary, GET /rewards/transactions) that provide balance and paginated transaction data.

## Technical Context

**Language/Version**: TypeScript 5.9.3 with React 19.2.0
**Primary Dependencies**:
- React 19.2.0 (UI framework)
- React Router (client-side routing for /rewards and /withdraw navigation)
- Vite 7.2.4 (build tool)
- date-fns or Intl.DateTimeFormat (Spanish date formatting)

**Storage**: N/A (frontend only - data fetched from backend APIs)
**Testing**: Vitest or Jest (React component testing), React Testing Library, MSW (API mocking)
**Target Platform**: Modern web browsers (Chrome, Firefox, Safari, Edge - last 2 versions; iOS Safari, Android Chrome)
**Project Type**: Web frontend (client/ directory in monorepo structure)
**Performance Goals**:
- Balance visible within 2 seconds of page load (SC-001)
- Support 1,000+ transactions per user without performance degradation (SC-004)
- Zero layout shift (CLS) for loading states (SC-008)
- Transaction grouping computation memoized (FR-052)

**Constraints**:
- 5-second API timeout threshold before error display (FR-053, clarification)
- Mobile-first design starting at 375px width, responsive to larger viewports (FR-059)
- No UI component libraries (MUI, Ant Design) - custom components only (Constitution II)
- Maximum 3 levels of folder nesting per feature (Constitution II)
- WCAG 2.1 AA accessibility compliance mandatory (FR-046, Constitution II)

**Scale/Scope**: Single-page feature with 6-8 React components, 2 custom hooks, 2 API integrations, full loading/error/empty state coverage

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Global Principle I: Production-Grade Engineering
✅ **PASS**:
- Feature-based architecture with clear component boundaries
- Minimal dependencies (React Router, date formatting utility)
- Custom hooks for reusable logic (useRewardsSummary, useRewardsTransactions)
- Unit tests planned for hooks and components
- Code maintainable with clear separation of concerns

### Global Principle II: React Frontend Architecture

#### Architecture & Structure
✅ **PASS**:
- Feature-based architecture: `client/src/features/rewards/` contains all rewards-related code
- Reusable components extracted to `client/src/components/` (ErrorState, LoadingState, EmptyState)
- Maximum 2 levels of nesting (features/rewards/components/, features/rewards/hooks/)
- Custom hooks: `useRewardsSummary`, `useRewardsTransactions` for stateful logic

#### UX Requirements
✅ **PASS**:
- Clear feedback for async operations: skeleton loaders (FR-025, FR-026), inline loading for pagination (FR-027)
- User-friendly error messages in Spanish with retry actions (FR-033, FR-034, clarification)
- Visual feedback: button disabled states (FR-013, FR-014), double-tap protection (FR-015)
- Responsive design per Figma specs (FR-059-065)

#### Non-Negotiables
✅ **PASS**:
- No UI component libraries - all components custom-built
- No premature optimizations - memoization only for expensive grouping computation (FR-052)
- React patterns kept simple - hooks and functional components
- Only 2 major dependencies added (React Router + date-fns)
- WCAG 2.1 AA compliance: keyboard navigation (FR-042), ARIA labels (FR-044), screen reader support (FR-029, FR-036), visible focus states (FR-045)

### Global Principle III: NestJS Backend Architecture
⚠️ **N/A - FRONTEND ONLY**: This feature is frontend-only and depends on existing backend APIs (GET /rewards/summary, GET /rewards/transactions). Backend architecture compliance is out of scope for this feature.

### Global Principle IV: Mandatory Testing Discipline
✅ **PASS**:
- Unit tests for custom hooks (useRewardsSummary, useRewardsTransactions)
- Component tests for main React components (RewardsHome, BalanceSummaryCard, TransactionList)
- Tests cover both happy paths and error scenarios (loading, empty, error states)
- API mocking with MSW for realistic behavior

### Constitution Compliance Summary
**Status**: ✅ **COMPLIANT**

All applicable constitutional principles are satisfied. This is a frontend-only feature with:
- Feature-based architecture (Principle II)
- Custom components without UI libraries (Principle II)
- Clear UX feedback patterns (Principle II)
- Full WCAG 2.1 AA accessibility (Principle II)
- Testable hooks and components (Principle IV)
- Production-grade engineering practices (Principle I)

Backend principle (III) is not applicable as this feature consumes existing APIs.

## Project Structure

### Documentation (this feature)

```text
specs/001-rewards-home/
├── spec.md              # Feature specification (input)
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output: technology decisions
├── data-model.md        # Phase 1 output: frontend state model
├── quickstart.md        # Phase 1 output: setup instructions
├── contracts/           # Phase 1 output: API contract references
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created yet)
```

### Source Code (repository root)

```text
client/
├── src/
│   ├── features/
│   │   └── rewards/
│   │       ├── components/
│   │       │   ├── RewardsHome.tsx         # Main page component
│   │       │   ├── RewardsHeader.tsx       # "Rewards" title
│   │       │   ├── BalanceSummaryCard.tsx  # Balance + "Retirar" button
│   │       │   ├── TransactionList.tsx     # Grouped transaction list
│   │       │   ├── TransactionItem.tsx     # Single transaction row
│   │       │   └── LoadMoreButton.tsx      # Pagination control
│   │       ├── hooks/
│   │       │   ├── useRewardsSummary.ts    # Balance fetching + loading/error states
│   │       │   └── useRewardsTransactions.ts # Transaction pagination + cursor management
│   │       ├── types/
│   │       │   └── rewards.types.ts        # TypeScript interfaces (RewardsSummary, Transaction, etc.)
│   │       ├── utils/
│   │       │   ├── formatCurrency.ts       # Locale-specific currency formatting
│   │       │   ├── formatDate.ts           # Spanish date/month formatting
│   │       │   ├── formatSignedAmount.ts   # +/- prefix for amounts
│   │       │   └── groupTransactionsByMonth.ts # Memoized grouping logic
│   │       └── api/
│   │           └── rewardsApi.ts           # API client functions
│   ├── components/                          # Shared/reusable components
│   │   ├── LoadingState.tsx                # Skeleton/loader placeholder
│   │   ├── ErrorState.tsx                  # Error message + retry button
│   │   └── EmptyState.tsx                  # "No activity yet" message
│   ├── assets/
│   │   └── icons/
│   │       └── arrow_right_line.svg        # Icon for "Retirar" button
│   ├── styles/
│   │   └── rewards.css                     # Feature-specific styles (design system tokens)
│   ├── App.tsx                             # Router setup (includes /rewards route)
│   ├── main.tsx                            # React root
│   └── index.css                           # Global styles
├── tests/
│   ├── features/
│   │   └── rewards/
│   │       ├── RewardsHome.test.tsx        # Component tests
│   │       ├── useRewardsSummary.test.ts   # Hook tests
│   │       └── useRewardsTransactions.test.ts
│   └── mocks/
│       ├── handlers.ts                     # MSW mock API handlers
│       └── server.ts                       # MSW test server setup
├── public/
│   └── vite.svg                            # Static assets
├── package.json
├── vite.config.ts
├── tsconfig.json
└── README.md
```

**Structure Decision**: Web application (frontend only). The existing repository has a `client/` directory for the React frontend. This feature adds a new `features/rewards/` module following feature-based architecture (Constitution II). Shared components (LoadingState, ErrorState, EmptyState) are placed in `client/src/components/` for reuse across features.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

N/A - No constitutional violations. All principles satisfied.

## Phase 0: Research & Technology Decisions

### Research Questions

The following technology decisions and unknowns need resolution before proceeding to detailed design:

1. **Date Formatting Library**: How to format dates in Spanish locale for month headers (e.g., "Septiembre 2025", "Agosto 2025")?
   - Option A: Native Intl.DateTimeFormat API (zero dependencies)
   - Option B: date-fns with es locale
   - **Decision needed**: Evaluate bundle size, browser support, and API ergonomics

2. **API Client Pattern**: How to structure API calls with x-user-id header injection, timeout handling, and error management?
   - Option A: Fetch API with custom wrapper
   - Option B: Axios with interceptors
   - Option C: React Query for caching + state management
   - **Decision needed**: Evaluate based on simplicity, timeout support, and header injection

3. **State Management**: How to manage loading/error/data states for API calls?
   - Option A: useState + useEffect (simple, no dependencies)
   - Option B: React Query (built-in loading/error/caching)
   - Option C: Custom hook abstraction over useState/useEffect
   - **Decision needed**: Balance simplicity vs. feature requirements (no caching needed per spec)

4. **Routing Library Selection**: Which routing solution for /rewards → /withdraw navigation?
   - Option A: React Router v6 (industry standard)
   - Option B: TanStack Router (type-safe, newer)
   - Option C: Next.js-style file-based routing (requires framework)
   - **Decision needed**: Evaluate maturity, TypeScript support, and constitution compliance

5. **Testing Framework**: Which testing tools for React component and hook testing?
   - Option A: Vitest + React Testing Library + MSW (fast, Vite-native)
   - Option B: Jest + React Testing Library + MSW (mature, widely adopted)
   - **Decision needed**: Evaluate Vite integration, speed, and ecosystem maturity

6. **Accessibility Testing**: How to validate WCAG 2.1 AA compliance?
   - Option A: Manual keyboard testing + screen reader testing
   - Option B: axe-core automated testing + manual validation
   - Option C: jest-axe in component tests
   - **Decision needed**: Determine automated vs. manual coverage

7. **Icon Management**: How to source and integrate arrow_right_line icon?
   - Option A: Heroicons library (MIT licensed)
   - Option B: Lucide React (MIT licensed, tree-shakeable)
   - Option C: Custom SVG inline
   - **Decision needed**: Evaluate bundle impact and reusability

8. **Currency Formatting**: How to handle locale-specific currency formatting?
   - Option A: Intl.NumberFormat API (zero dependencies)
   - Option B: Accounting.js or currency.js
   - **Decision needed**: Validate browser support for Intl.NumberFormat and required locales

### Research Output

See [research.md](./research.md) for detailed analysis and final technology decisions.

## Phase 1: Design Artifacts

### Data Model

See [data-model.md](./data-model.md) for frontend state model including:
- RewardsSummary type (balance, currency)
- Transaction type (id, type, amount, description, createdAt)
- PaginatedTransactions type (transactions[], nextCursor, hasMore, count)
- TransactionGroup type (month, year, transactions[])
- Loading/error state types

### API Contracts

See [contracts/](./contracts/) for:
- GET /rewards/summary request/response format
- GET /rewards/transactions request/response format with cursor pagination
- Error response format (RFC 7807 assumed based on backend pattern)

### Quickstart

See [quickstart.md](./quickstart.md) for:
- Local development setup
- Running the frontend dev server
- Running tests
- Building for production
- Accessibility testing procedures

## Phase 2: Task Breakdown

**Note**: Task breakdown is generated by the `/speckit.tasks` command (separate invocation). See `tasks.md` after running `/speckit.tasks`.

## Post-Design Constitution Re-check

*Re-evaluated after Phase 1 design completion*

### Global Principle I: Production-Grade Engineering
✅ **PASS**: Architecture maintains clear boundaries. Dependencies finalized in research phase. All components and hooks have corresponding test files.

### Global Principle II: React Frontend Architecture
✅ **PASS**:
- Feature structure confirmed in project tree
- Component extraction patterns defined
- 2-level nesting maintained (features/rewards/components/, features/rewards/hooks/)
- Custom hooks encapsulate stateful logic
- Accessibility patterns documented in contracts

### Global Principle IV: Mandatory Testing Discipline
✅ **PASS**: Test structure defined with unit tests for hooks, component tests for UI, and MSW mocks for API integration testing.

**Final Status**: ✅ **COMPLIANT** - All constitutional requirements satisfied in final design.

## Implementation Notes

### Critical Path
1. Setup routing (/rewards route)
2. Implement API client with x-user-id header injection and 5-second timeout
3. Build useRewardsSummary hook with loading/error/data states
4. Build useRewardsTransactions hook with cursor-based pagination
5. Implement BalanceSummaryCard (balance + "Retirar" button)
6. Implement TransactionList with month grouping
7. Implement loading/error/empty states
8. Add accessibility attributes (ARIA labels, keyboard navigation)
9. Style components per Figma specifications (FR-059-065)
10. Test keyboard navigation and screen reader compatibility

### Risk Mitigation
- **Risk**: API timeout edge cases not covered
  - **Mitigation**: Implement comprehensive error handling with user-friendly Spanish messages per clarification
- **Risk**: Layout shift (CLS) during loading
  - **Mitigation**: Use skeleton loaders matching final content dimensions (FR-025, FR-026)
- **Risk**: Accessibility gaps
  - **Mitigation**: Use jest-axe automated testing + manual keyboard/screen reader validation
- **Risk**: Memoization not preventing expensive re-renders
  - **Mitigation**: Profile groupTransactionsByMonth with React DevTools Profiler

### Success Validation
- [ ] All functional requirements (FR-001 through FR-065) testable and passing
- [ ] All success criteria (SC-001 through SC-015) measurable and achieved
- [ ] All acceptance scenarios from user stories passing
- [ ] WCAG 2.1 AA compliance validated with axe-core
- [ ] Loading states show within 100ms, balance within 2 seconds
- [ ] Error messages in Spanish with retry actions
- [ ] Keyboard navigation fully functional (Tab, Enter, Space)
- [ ] Screen reader announces loading/error states appropriately
- [ ] Zero layout shift measured via Chrome DevTools
- [ ] Responsive design tested at 375px, 768px, 1024px, 1440px breakpoints
