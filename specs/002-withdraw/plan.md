# Implementation Plan: Withdraw - Choose Method and Amount

**Branch**: `002-withdraw` | **Date**: 2026-01-11 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-withdraw/spec.md` + API response contract

**Note**: This plan is generated by the `/speckit.plan` command based on the feature specification, clarifications, and provided API contract.

## Summary

This feature implements the withdrawal account selection screen within the existing React-based rewards application. Users can navigate to `/withdraw` to view their rewards balance, select a bank account from `/withdraw/accounts`, and prepare for withdrawal submission (US3). The implementation extends the existing rewards feature architecture with two new routes, account fetching/selection logic, and comprehensive loading/error state handling. Following the established patterns from 001-rewards-home, this feature maintains WCAG 2.1 AA accessibility, mobile-first responsive design, and zero-dependency state management using React hooks.

**Key Technical Approach**:
- Extend existing `client/src/features/rewards/` structure with withdraw-specific components
- Reuse shared components (LoadingState, ErrorState, EmptyState) and utilities (formatCurrency, logger) from rewards-home
- Implement two new routes: `/withdraw` (main screen) and `/withdraw/accounts` (selection list)
- Create custom hook `useBankAccounts` following the pattern of `useRewardsSummary`
- Use React Router state/context for selected account persistence between routes
- Leverage existing API client pattern with x-user-id header authentication

## Technical Context

**Language/Version**: TypeScript 5.9.3 with React 19.2.0
**Primary Dependencies**:
- React 19.2.0 (UI framework)
- React Router 7.12.0 (already installed - client-side routing for /withdraw and /withdraw/accounts)
- Vite 7.2.4 (build tool - already configured)
- No new dependencies required (reuse existing patterns)

**Storage**: N/A (frontend only - data fetched from GET /bank-accounts API; selected account stored in React Router location state)
**Testing**: Vitest 4.0.16 + React Testing Library + MSW (API mocking) - already configured from 001-rewards-home
**Target Platform**: Modern web browsers (Chrome, Firefox, Safari, Edge - last 2 versions; iOS Safari, Android Chrome)
**Project Type**: Web frontend (client/ directory in monorepo structure)

**Performance Goals**:
- Navigation to withdraw screen < 1 second (SC-001)
- Account list selection with up to 50 accounts without lag (SC-002)
- 100% duplicate submission prevention (SC-003)
- Loading feedback within 200ms (SC-004)
- Account list loads within 2 seconds (SC-008)
- Zero layout shift (CLS = 0) during loading (SC-009)

**Constraints**:
- 5-second API timeout threshold (inherited from rewards-home pattern)
- Mobile-first design at 375px width per FR-036 specifications
- No UI component libraries (Constitution II - use existing pattern)
- Reuse existing shared components and utilities
- WCAG 2.1 AA accessibility compliance mandatory (FR-028-035)
- Button double-tap protection required (FR-019, SC-003)

**Scale/Scope**:
- 4-5 new React components (WithdrawScreen, AccountSelector, AccountList, AccountListItem)
- 1 new custom hook (useBankAccounts)
- 1 new API integration (GET /bank-accounts)
- Reuse 3 existing shared components (LoadingState, ErrorState, EmptyState)
- Full loading/error/empty state coverage per user stories

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Global Principle I: Production-Grade Engineering
✅ **PASS**:
- Extends established feature-based architecture from 001-rewards-home
- Zero new external dependencies (reuses React Router, Vitest, MSW)
- Custom hook `useBankAccounts` follows proven `useRewardsSummary` pattern
- Clear component boundaries and separation of concerns
- Unit tests planned for hooks and components using existing test infrastructure

### Global Principle II: React Frontend Architecture

#### Architecture & Structure
✅ **PASS**:
- Feature-based architecture: extends `client/src/features/rewards/` with withdraw components
- Reuses shared components from `client/src/components/` (ErrorState, LoadingState, EmptyState)
- Maximum 2 levels of nesting maintained (features/rewards/components/withdraw/)
- Custom hook: `useBankAccounts` for account fetching and state management
- Co-locates withdraw feature with rewards since it's part of the same business domain

#### UX Requirements
✅ **PASS**:
- Clear feedback for async operations: skeleton loaders for account fetching (FR-021), loading indicator on submit button (FR-020)
- User-friendly error messages in Spanish with retry actions (FR-024, FR-025)
- Visual feedback: button disabled states (FR-015, FR-016), account selection state (FR-011)
- Focus management for keyboard users (FR-032-034)
- Responsive design per provided FR-036-045 specifications

#### Non-Negotiables
✅ **PASS**:
- No UI component libraries - extends existing custom component patterns
- No premature optimizations - straightforward account list rendering (50 account limit per FR-046)
- React patterns kept simple - hooks and functional components only
- Zero new major dependencies (React Router already installed)
- WCAG 2.1 AA compliance: keyboard navigation (FR-028-030), ARIA labels (FR-031, FR-035), screen reader announcements (FR-023, FR-027), visible focus states (per existing CSS patterns)

### Global Principle III: NestJS Backend Architecture
⚠️ **N/A - FRONTEND ONLY**: This feature is frontend-only and depends on existing backend API (GET /bank-accounts). Backend architecture compliance is out of scope for this feature. Backend team must ensure GET /bank-accounts endpoint returns the documented contract.

### Global Principle IV: Mandatory Testing Discipline
✅ **PASS**:
- Unit tests for custom hook (useBankAccounts) covering success, loading, error, and retry scenarios
- Component tests for main React components (WithdrawScreen, AccountSelector, AccountList, AccountListItem)
- Integration tests for full user flows with MSW-mocked API
- Tests cover all user stories: account selection (US1), loading/error states (US2), duplicate prevention (US3)
- Accessibility tests using jest-axe (following 001-rewards-home pattern)
- API mocking with MSW using provided response contract

### Constitution Compliance Summary
**Status**: ✅ **COMPLIANT**

All applicable constitutional principles are satisfied. This feature:
- Extends existing feature-based architecture without introducing complexity (Principle II)
- Reuses shared components and utilities from 001-rewards-home (Principle I, II)
- Zero new dependencies (Principle II Non-Negotiable #4)
- Full WCAG 2.1 AA accessibility (Principle II Non-Negotiable #5)
- Testable hooks and components using existing test infrastructure (Principle IV)
- Production-grade engineering practices (Principle I)

Backend principle (III) is not applicable as this feature consumes an existing API endpoint.

## Project Structure

### Documentation (this feature)

```text
specs/002-withdraw/
├── spec.md              # Feature specification (complete)
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (technology decisions, patterns)
├── data-model.md        # Phase 1 output (TypeScript types, state shape)
├── contracts/           # Phase 1 output (API contracts)
│   └── GET-bank-accounts.md
└── quickstart.md        # Phase 1 output (setup and testing guide)
```

### Source Code (extends existing rewards feature)

```text
client/src/features/rewards/
├── components/
│   ├── withdraw/                      # NEW: Withdraw feature components
│   │   ├── WithdrawScreen.tsx         # Main /withdraw page component
│   │   ├── AccountSelector.tsx        # Account selector control
│   │   ├── AccountList.tsx            # /withdraw/accounts list page
│   │   └── AccountListItem.tsx        # Individual account item
│   ├── RewardsHome.tsx                # EXISTING: Main rewards page
│   ├── BalanceSummaryCard.tsx         # EXISTING: Reused for balance display
│   └── [other existing components]
├── hooks/
│   ├── useBankAccounts.ts             # NEW: Fetch and manage bank accounts
│   ├── useRewardsSummary.ts           # EXISTING: Balance data (reused)
│   └── [other existing hooks]
├── types/
│   ├── bankAccount.types.ts           # NEW: Bank account TypeScript types
│   ├── withdraw.types.ts              # NEW: Withdraw-specific types
│   ├── rewards.types.ts               # EXISTING: Rewards types
│   └── api.types.ts                   # EXISTING: API error types (reused)
├── api/
│   ├── bankAccountsApi.ts             # NEW: GET /bank-accounts client
│   └── rewardsApi.ts                  # EXISTING: Rewards API client
├── utils/
│   ├── formatCurrency.ts              # EXISTING: Reused for amount display
│   ├── logger.ts                      # EXISTING: Reused for error logging
│   └── [other existing utilities]
├── constants/
│   ├── errorMessages.ts               # EXTENDED: Add withdraw error messages
│   └── [other existing constants]
└── styles/
    ├── withdraw.css                   # NEW: Withdraw-specific styles
    └── rewards.css                    # EXISTING: Shared rewards styles

client/src/components/                 # EXISTING: Shared components (reused)
├── LoadingState.tsx
├── ErrorState.tsx
└── EmptyState.tsx

client/src/App.tsx                     # MODIFIED: Add withdraw routes
├── Route /withdraw -> WithdrawScreen
└── Route /withdraw/accounts -> AccountList

client/tests/features/rewards/withdraw/  # NEW: Withdraw feature tests
├── WithdrawScreen.test.tsx
├── AccountSelector.test.tsx
├── AccountList.test.tsx
├── AccountListItem.test.tsx
├── useBankAccounts.test.ts
└── accessibility-checklist.md

client/tests/mocks/
└── handlers.ts                        # EXTENDED: Add GET /bank-accounts mock
```

**Structure Decision**:

This feature extends the existing `client/src/features/rewards/` structure rather than creating a new feature directory because:

1. **Business Domain Cohesion**: Withdrawal is part of the rewards flow (users withdraw accumulated rewards)
2. **Code Reuse**: Heavily reuses rewards components (BalanceSummaryCard for amount display), hooks (useRewardsSummary for balance), and utilities (formatCurrency, logger)
3. **Shared State**: Withdraw screen depends on rewards balance from US1 (rewards-home)
4. **User Journey**: Natural extension of rewards feature (view balance → initiate withdrawal)
5. **Routing Continuity**: Both features under `/rewards` and `/withdraw` routes share navigation context

Withdraw-specific components are isolated in `components/withdraw/` subdirectory to maintain clear boundaries while keeping related code co-located.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**Status**: N/A - No constitution violations. All checks pass.

---

## Phase 0: Research & Technology Selection

### Objective
Identify reusable patterns from 001-rewards-home and determine approach for account selection state management.

### Technology Decisions

#### 1. State Management for Selected Account

**Decision**: Use React Router's `useNavigate` with location state for account persistence between routes.

**Rationale**:
- Zero new dependencies (React Router already installed)
- Built-in browser back/forward support
- Simple API: `navigate('/withdraw', { state: { selectedAccount } })`
- Matches pattern from rewards-home (no external state management library)
- Account selection is transient (only needed during withdrawal flow, cleared after submission)

**Alternatives Rejected**:
- Context API: Overkill for single piece of state shared between 2 routes
- localStorage: Unnecessary persistence (selection only matters during active session)
- URL query params: Exposes account ID in URL (security concern)
- Redux/Zustand: Violates Constitution II Non-Negotiable #4 (no new major dependencies)

#### 2. API Client Pattern

**Decision**: Follow existing `rewardsApi.ts` pattern with `fetchWithTimeout` utility.

**Rationale**:
- Consistent with established codebase patterns
- Already implements 5-second timeout (matches requirements)
- Includes x-user-id header authentication
- Error handling and logging infrastructure in place
- TypeScript types for API responses

**Implementation**:
```typescript
// New file: client/src/features/rewards/api/bankAccountsApi.ts
export async function getBankAccounts(): Promise<BankAccountsResponse> {
  const url = `${API_BASE_URL}/bank-accounts`;
  const response = await fetchWithTimeout(url); // Reuses existing utility
  const data = await response.json();
  return data;
}
```

#### 3. Custom Hook Pattern

**Decision**: Create `useBankAccounts` hook following `useRewardsSummary` pattern.

**Rationale**:
- Proven pattern from 001-rewards-home
- Encapsulates fetching, loading, error state
- Provides refetch function for retry functionality
- Testable in isolation with MSW
- No external state management needed

**Hook API**:
```typescript
interface UseBankAccountsReturn {
  accounts: BankAccount[];
  loading: boolean;
  error: Error | null;
  refetch: () => Promise<void>;
}

function useBankAccounts(): UseBankAccountsReturn
```

#### 4. Component Structure

**Decision**: Create 4 new components following existing rewards component patterns.

**Components**:
1. **WithdrawScreen** (`/withdraw` route)
   - Displays balance (reuses BalanceSummaryCard logic)
   - Shows AccountSelector
   - Renders primary action button with state management

2. **AccountSelector** (withdraw screen control)
   - Displays placeholder or selected account
   - Handles click to navigate to /withdraw/accounts
   - Shows loading/error states inline

3. **AccountList** (`/withdraw/accounts` route)
   - Fetches accounts with useBankAccounts hook
   - Renders list of AccountListItem components
   - Handles loading/error/empty states with shared components

4. **AccountListItem** (individual account in list)
   - Displays masked account (•••• 1234) and type
   - Handles selection (navigates back with state)
   - Keyboard accessible (Enter/Space)

**Rationale**: Follows single-responsibility principle; each component has clear purpose; reuses shared LoadingState/ErrorState/EmptyState components.

#### 5. Styling Approach

**Decision**: Create new `withdraw.css` file following existing `rewards.css` pattern.

**Rationale**:
- Matches established CSS organization
- Uses CSS custom properties (design tokens) from rewards.css
- Mobile-first media queries (375px base)
- No CSS-in-JS or Tailwind (maintains consistency)

**Design Tokens** (inherited from rewards.css):
- Colors: `--rewards-accent: #33CAFF`, `--rewards-disabled: #CBD5E1`
- Typography: `--text-small`, `--text-5xl` (from FR-038, FR-039)
- Spacing: `--spacing-24: 24px`, `--gap-24: 24px` (from FR-036)
- Layout: `width: 375px`, `padding: 24px` (from FR-036)

#### 6. Focus Management

**Decision**: Use `useEffect` with `ref.current.focus()` for focus restoration.

**Rationale**:
- Standard React pattern for focus management
- Meets FR-034 requirement (focus returns to button after selection)
- No additional libraries needed
- Testable with Testing Library's `expect(element).toHaveFocus()`

**Implementation Pattern**:
```typescript
const buttonRef = useRef<HTMLButtonElement>(null);

useEffect(() => {
  const state = location.state as { selectedAccount?: BankAccount };
  if (state?.selectedAccount && buttonRef.current) {
    buttonRef.current.focus(); // FR-034: Focus on button after account selection
  }
}, [location.state]);
```

#### 7. Double-Tap Prevention

**Decision**: Use `isSubmitting` state flag (immediate state change pattern).

**Rationale**:
- Simpler than debouncing libraries
- Matches button disabled logic from BalanceSummaryCard
- Meets FR-019 and SC-003 requirements
- No race conditions (state change is synchronous)

**Implementation Pattern**:
```typescript
const [isSubmitting, setIsSubmitting] = useState(false);

const handleSubmit = () => {
  if (isSubmitting) return; // Guard against double-tap
  setIsSubmitting(true);
  // Submit logic (US3 - out of scope)
};
```

### Research Summary

**Reusable Assets from 001-rewards-home**:
- ✅ Shared components: LoadingState, ErrorState, EmptyState
- ✅ API client pattern: fetchWithTimeout utility
- ✅ Custom hook pattern: useAsync* structure
- ✅ Error messages: Spanish messages in constants/errorMessages.ts
- ✅ Logging: logger.ts for API failures and errors
- ✅ Testing setup: Vitest + RTL + MSW + jest-axe
- ✅ CSS patterns: Design tokens, mobile-first, focus states

**New Implementations Required**:
- ❌ Bank accounts API client (`bankAccountsApi.ts`)
- ❌ Bank accounts hook (`useBankAccounts.ts`)
- ❌ Withdraw components (4 new components)
- ❌ TypeScript types for bank accounts
- ❌ Withdraw-specific styles
- ❌ MSW mock for GET /bank-accounts
- ❌ Account selection state management (React Router state)
- ❌ Focus management for accessibility

---

## Phase 1: Design & Contracts

### Data Model

See [data-model.md](./data-model.md) for complete TypeScript type definitions.

**Key Types**:

```typescript
// Bank Account from API
interface BankAccount {
  id: string;
  lastFourDigits: string;
  accountType: string;
  isActive: boolean;
  createdAt: string;
}

// API Response
interface BankAccountsResponse {
  accounts: BankAccount[];
  count: number;
}

// Selected Account State (persisted in React Router location state)
interface WithdrawLocationState {
  selectedAccount?: BankAccount;
}
```

### API Contracts

See [contracts/GET-bank-accounts.md](./contracts/GET-bank-accounts.md) for detailed API contract.

**Summary**:

**Endpoint**: `GET /bank-accounts`

**Headers**:
- `x-user-id`: string (required) - User identification for authentication

**Response 200 OK**:
```json
{
  "accounts": [
    {
      "id": "bank-account-002",
      "lastFourDigits": "4321",
      "accountType": "Savings",
      "isActive": true,
      "createdAt": "2026-01-11T17:49:07.091Z"
    }
  ],
  "count": 2
}
```

**Error Responses**:
- 401 Unauthorized: Missing or invalid x-user-id
- 500 Internal Server Error: Server failure

**Behavior**:
- Returns only accounts belonging to authenticated user
- Accounts sorted by createdAt descending (newest first)
- Includes both active and inactive accounts (frontend filters for isActive: true)

### Component Hierarchy

```text
App
└── Routes
    ├── /withdraw → WithdrawScreen
    │   ├── RewardsHeader (reused)
    │   ├── BalanceDisplay (shows amount from rewards)
    │   ├── AccountSelector
    │   │   ├── LoadingState (if loading accounts)
    │   │   ├── ErrorState (if accounts failed to load)
    │   │   └── Button (shows placeholder or selected account)
    │   └── SubmitButton (primary action, disabled when no selection)
    │
    └── /withdraw/accounts → AccountList
        ├── RewardsHeader (reused)
        ├── LoadingState (while fetching accounts)
        ├── ErrorState (if fetch failed)
        ├── EmptyState (if no accounts)
        └── [AccountListItem] (list of accounts)
            └── Button (selectable account item)
```

### User Flow Diagrams

**Happy Path** (US1 - Select Account):
```
1. User clicks "Retirar" on /rewards
   → Navigates to /withdraw

2. WithdrawScreen mounts
   → useBankAccounts fetches GET /bank-accounts
   → Shows loading state in AccountSelector

3. Accounts load successfully
   → AccountSelector shows placeholder "Selecciona una cuenta"
   → Submit button disabled

4. User clicks AccountSelector
   → Navigates to /withdraw/accounts

5. AccountList shows accounts
   → User clicks AccountListItem (e.g., "•••• 1234")

6. Returns to /withdraw with selected account
   → AccountSelector shows "•••• 1234"
   → Submit button enabled
   → Focus moves to submit button (FR-034)

7. User presses Enter (keyboard accessible)
   → Submits withdrawal (US3 - out of scope)
```

**Error Path** (US2 - Handle Errors):
```
1. User navigates to /withdraw
2. useBankAccounts fetches GET /bank-accounts
3. API returns 500 error
   → AccountSelector shows ErrorState
   → Message: "No pudimos cargar tus cuentas bancarias"
   → Retry button visible

4. User clicks "Intentar de nuevo"
   → refetch() triggers new API call
   → Shows loading state again

5. Success or persistent error
   → Success: Show accounts
   → Error: Show error again with retry option
```

**Edge Case** (No Accounts):
```
1. User navigates to /withdraw
2. useBankAccounts fetches GET /bank-accounts
3. API returns {accounts: [], count: 0}
   → AccountSelector shows EmptyState
   → Message: "No tienes cuentas bancarias vinculadas"
   → Guidance to add account (design dependent)
```

### State Management

**Local Component State**:
- `isSubmitting`: boolean (WithdrawScreen) - Prevents double-tap
- `selectedAccount`: BankAccount | null (derived from React Router state)

**Hook State** (useBankAccounts):
- `accounts`: BankAccount[] - Fetched accounts
- `loading`: boolean - Fetch in progress
- `error`: Error | null - Fetch error

**Router State** (React Router location.state):
- `selectedAccount`: BankAccount - Persisted between /withdraw and /withdraw/accounts

**Shared State** (from rewards-home):
- Rewards balance: Retrieved via useRewardsSummary hook (reused)

### Focus Management Plan

**Forward Navigation** (/withdraw → /withdraw/accounts):
- On AccountList mount → Focus moves to page title (FR-033)

**Backward Navigation** (/withdraw/accounts → /withdraw after selection):
- On WithdrawScreen mount → Detect `location.state.selectedAccount`
- If present → Focus moves to submit button via `buttonRef.current.focus()` (FR-034)

**Keyboard Navigation** (within AccountList):
- Tab/Shift+Tab → Moves between AccountListItem buttons
- Enter/Space → Selects account and navigates back

### Accessibility Requirements Summary

Per FR-028 through FR-035 and WCAG 2.1 AA:

1. **Keyboard Navigation**:
   - All interactive elements (AccountSelector, AccountListItem, Submit button) must be focusable
   - Tab order: logical top-to-bottom flow
   - Enter/Space activates buttons

2. **ARIA Labels**:
   - AccountSelector: `aria-label="Selecciona una cuenta bancaria"`
   - AccountListItem: `aria-label="Cuenta {accountType} terminada en {lastFourDigits}"`
   - Submit button: `aria-label="Continuar con retiro"` + `aria-disabled` state

3. **Screen Reader Announcements**:
   - Loading: `role="status"` + `aria-live="polite"` + "Cargando cuentas"
   - Error: `role="alert"` + `aria-live="assertive"` + Error message

4. **Focus States**:
   - Visible outline (2px solid, per existing rewards.css pattern)
   - High contrast (3:1 minimum)

5. **Focus Management**:
   - Forward nav: Focus on AccountList title
   - Backward nav: Focus on submit button (after selection)

---

## Phase 2: Implementation Strategy

**Note**: Detailed task breakdown will be generated by `/speckit.tasks` command after this plan is approved.

### Implementation Order (by User Story Priority)

**Phase 2.1: Foundation** (Dependencies)
1. Create TypeScript types (`bankAccount.types.ts`, `withdraw.types.ts`)
2. Create API client (`bankAccountsApi.ts` following rewards API pattern)
3. Add MSW mock handler for GET /bank-accounts
4. Extend error messages constants with withdraw-specific messages

**Phase 2.2: User Story 1 - Select Account (P1 - Critical Path)**
5. Create `useBankAccounts` hook (following `useRewardsSummary` pattern)
6. Write hook tests (success, loading, error, retry scenarios)
7. Create `WithdrawScreen` component (main /withdraw page)
8. Create `AccountSelector` component (inline on withdraw screen)
9. Create `AccountList` component (/withdraw/accounts route)
10. Create `AccountListItem` component (individual account display)
11. Write component tests (render, selection, navigation)
12. Add routes to App.tsx (/withdraw, /withdraw/accounts)
13. Integration test: Full account selection flow with MSW

**Phase 2.3: User Story 2 - Loading & Error States (P2)**
14. Integrate LoadingState in AccountSelector (while fetching)
15. Integrate ErrorState in AccountSelector (on fetch failure)
16. Integrate EmptyState in AccountList (when accounts.length === 0)
17. Implement retry functionality in ErrorState
18. Write loading/error state tests

**Phase 2.4: User Story 3 - Duplicate Prevention (P2)**
19. Add `isSubmitting` state to WithdrawScreen
20. Implement button disable logic (no account OR isSubmitting)
21. Add loading indicator to submit button
22. Write duplicate prevention tests (rapid click)

**Phase 2.5: Styles & Accessibility**
23. Create `withdraw.css` following FR-036 through FR-045 specifications
24. Implement focus management (FR-033, FR-034)
25. Add ARIA labels to all interactive elements (FR-031, FR-035)
26. Add keyboard event handlers (Enter/Space on AccountListItem)
27. Write accessibility tests with jest-axe
28. Manual accessibility checklist validation

**Phase 2.6: Polish & Validation**
29. Run linter and fix issues
30. Verify all 49 functional requirements (FR-001 through FR-049)
31. Verify all 10 success criteria (SC-001 through SC-010)
32. Manual testing on mobile viewport (375px)
33. Cross-browser testing (Chrome, Firefox, Safari)
34. Performance profiling (account list with 50 accounts)

### Testing Strategy

**Unit Tests**:
- `useBankAccounts.test.ts`: Hook behavior (success, loading, error, refetch)
- API mocking with MSW for all scenarios

**Component Tests**:
- `WithdrawScreen.test.tsx`: Render, balance display, button states
- `AccountSelector.test.tsx`: Placeholder, selected account, loading/error states
- `AccountList.test.tsx`: Account rendering, empty state, error state
- `AccountListItem.test.tsx`: Display format, selection, keyboard events

**Integration Tests**:
- Full user flow: /withdraw → select account → return with selection
- Error recovery: Fetch failure → retry → success
- Empty state: No accounts → show empty message

**Accessibility Tests**:
- jest-axe: No violations in all components
- Manual: Keyboard navigation, screen reader announcements, focus management

**Performance Tests**:
- Render 50 accounts without lag (SC-002)
- No layout shift during loading (SC-009)

### Critical Paths

**Must Work for MVP**:
1. ✅ Navigate to /withdraw
2. ✅ Fetch and display bank accounts
3. ✅ Select account from list
4. ✅ Return to withdraw screen with selection
5. ✅ Enable submit button after selection
6. ✅ Handle loading states gracefully
7. ✅ Handle API errors with retry

**Can Defer** (if time-constrained):
- Empty state edge case (assumes users have ≥1 account)
- Inactive account filtering (if backend ensures only active accounts returned)

### Risk Mitigation

**Risk 1**: GET /bank-accounts API not ready
- **Mitigation**: Use MSW mocks for all development and testing
- **Fallback**: Create static JSON file for demo purposes

**Risk 2**: React Router state loss on refresh
- **Impact**: Selected account lost if user refreshes /withdraw page
- **Mitigation**: Document in assumptions (selection is transient)
- **Alternative**: Use sessionStorage as backup (if needed)

**Risk 3**: Performance with 50 accounts
- **Mitigation**: Test early with mock data (50 accounts)
- **Fallback**: Virtual scrolling if rendering is slow (unlikely with 50 items)

**Risk 4**: Accessibility validation time
- **Mitigation**: Reuse accessibility patterns from 001-rewards-home
- **Fallback**: Manual testing checklist (faster than full screen reader testing)

### Success Criteria Validation Plan

After implementation, validate each SC:

- **SC-001**: Use Chrome DevTools Performance tab to measure navigation time
- **SC-002**: Render 50 accounts in AccountList, verify no UI freezing
- **SC-003**: Write test with rapid button clicks, assert single submission
- **SC-004**: Use React DevTools to verify loading state renders within 200ms
- **SC-005**: Manual keyboard navigation test (Tab through all elements)
- **SC-006**: Manual screen reader test (VoiceOver on macOS, NVDA on Windows)
- **SC-007**: Test retry button with MSW, verify refetch occurs
- **SC-008**: Use Network throttling in DevTools, verify <2s load time
- **SC-009**: Use Lighthouse CLS metric, verify 0 shift
- **SC-010**: User testing session (if possible) or analytics tracking

---

## Dependencies & Blockers

### External Dependencies

**Backend API** (BLOCKING):
- GET /bank-accounts endpoint must be implemented and deployed
- Must return contract specified in contracts/GET-bank-accounts.md
- Must support x-user-id header authentication
- **Status**: Pending backend implementation
- **Owner**: Backend team
- **Blocker Mitigation**: Use MSW mocks for all frontend development

**Rewards Home Feature** (COMPLETED):
- Balance data needed for withdraw screen
- useRewardsSummary hook must be available
- formatCurrency utility must be available
- **Status**: ✅ Implemented in 001-rewards-home

**React Router** (COMPLETED):
- Client-side routing configured
- Routes for /rewards and /withdraw defined
- **Status**: ✅ Installed and configured

### Internal Dependencies

**Design Assets**:
- FR-036 through FR-045 specifications are complete
- Typography tokens documented
- Color tokens documented
- **Status**: ✅ Complete (provided in spec)

**Testing Infrastructure**:
- Vitest + React Testing Library configured
- MSW configured
- jest-axe configured
- **Status**: ✅ Complete (from 001-rewards-home)

### Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Backend API delayed | High | Medium | Use MSW mocks; deploy frontend first |
| Accessibility issues found late | Medium | Low | Reuse proven patterns; test incrementally |
| Performance issues with 50 accounts | Low | Low | Test early; virtual scrolling fallback |
| React Router state loss on refresh | Low | Low | Document in assumptions; sessionStorage fallback |

---

## Next Steps

1. ✅ **Review and approve this plan** (`/speckit.plan` output)
2. ⏭️ **Generate task breakdown** (`/speckit.tasks` command)
3. ⏭️ **Begin Phase 2.1** (Foundation: Types, API client, MSW mocks)
4. ⏭️ **Implement US1** (P1 - Select Account - critical path)
5. ⏭️ **Implement US2** (P2 - Loading/Error States)
6. ⏭️ **Implement US3** (P2 - Duplicate Prevention)
7. ⏭️ **Polish & Validate** (Styles, accessibility, testing)

**Estimated Effort**: 3-5 days for experienced React developer (based on 001-rewards-home complexity)

**Ready for Implementation**: ✅ YES (pending plan approval)
